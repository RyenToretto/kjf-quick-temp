/**
 * @desc: gen script command，make a new page generated by one click.
 * @author: nicejade
 */

const fs = require('fs')
const path = require('path')
const colors = require('colors')

const newFolderName = process.argv[2]

String.prototype.firstUpperCase = function() {
  return this.replace(/\b(\w)/g, $1 => {
    return $1.toLowerCase()
  })
}
const resolve = dir => {
  return path.join(__dirname, '../..', dir)
}

const successExecPrint = msg => {
  console.log(colors.green(`✓ `) + colors.cyan(`${msg} `) + colors.green('任务开始.'))
}

function createNewPage(newFolderPath) {
  const mReg = new RegExp('@PAGE_CLASS_NAME', 'g')
  const pageContent = fs.readFileSync(`${__dirname}/template.ux`, 'UTF-8')
  const rootClassName = newFolderName
    .firstUpperCase()
    .replace(/([A-Z])/g, '-$1')
    .toLowerCase()
  const newContent = pageContent.replace(mReg, rootClassName)

  fs.mkdirSync(newFolderPath, 0o777)
  fs.writeFile(`${newFolderPath}/index.ux`, newContent, error => {
    if (error) throw `出错了 error: ${error}`
  })
  successExecPrint('创建新页面')
}

function saveRouter2Manifest() {
  const manifestPath = resolve('/src/manifest.json')
  let manifestConf = fs.readFileSync(manifestPath, 'UTF-8')
  manifestConf = JSON.parse(manifestConf)
  const routerPages = manifestConf.router.pages
  routerPages[`pages/${newFolderName}`] = {
    component: 'index'
  }
  manifestConf = JSON.stringify(manifestConf, null, 2)
  fs.writeFile(manifestPath, manifestConf, error => {
    if (error) throw `出错了[@写入新页面路由]: ${error}`
  })
  successExecPrint('写入新页面的路由到 manifest.json')
}

function main() {
  if (!newFolderName) {
    return console.warn(`⚠️  请输入要创建的新页面名称.`.underline.red)
  }

  const folderNameReg = /^[A-Z][[A-Za-z0-9]+$/
  if (!folderNameReg.test(newFolderName)) {
    return console.warn(`⚠️  请输入正确格式的文件夹名称. Eg: XyzAbcde.`.underline.red)
  }

  const newFolderPath = path.join(__dirname, `../../src/pages/${newFolderName}`)
  const isExist = fs.existsSync(newFolderPath)

  if (isExist) {
    return console.warn(`⚠️  在 /src/pages/ 中已存在 ${newFolderName} 的文件夹.`.underline.red)
  }
  createNewPage(newFolderPath)
  saveRouter2Manifest()
}

main()
